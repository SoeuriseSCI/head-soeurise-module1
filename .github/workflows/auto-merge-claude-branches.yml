name: Auto-merge Claude Code branches

on:
  push:
    branches:
      - 'claude/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get branch name
        id: branch
        run: echo "name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      - name: Check if PR already exists
        id: check-pr
        run: |
          PR_NUMBER=$(gh pr list --head "${{ steps.branch.outputs.name }}" --base main --json number --jq '.[0].number')
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request if needed
        if: steps.check-pr.outputs.pr_number == ''
        id: create-pr
        run: |
          PR_URL=$(gh pr create \
            --base main \
            --head "${{ steps.branch.outputs.name }}" \
            --title "ðŸ¤– Auto-merge: Changements Claude Code" \
            --body "Changements automatiques depuis Claude Code.

          **Branche**: \`${{ steps.branch.outputs.name }}\`
          **Commit**: ${{ github.sha }}

          Merge automatique activÃ©.

          ðŸ¤– Generated by GitHub Actions")

          PR_NUMBER=$(echo "$PR_URL" | grep -oP '\d+$')
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge Pull Request
        run: |
          PR_NUMBER="${{ steps.check-pr.outputs.pr_number || steps.create-pr.outputs.pr_number }}"
          if [ -n "$PR_NUMBER" ]; then
            gh pr merge "$PR_NUMBER" --merge --delete-branch --admin
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
